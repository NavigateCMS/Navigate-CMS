(function(m){"function"===typeof define&&define.amd?define(["jquery","./grid.grouping"],m):"object"===typeof exports?m(require("jquery")):m(jQuery)})(function(m){function J(d,c,k){if(!(this instanceof J))return new J(d);this.aggregator=d;this.finilized=!1;this.context=c;this.pivotOptions=k}function D(d,c,k,l,n){var g=l.length,x=function(b,a){var d=b,c=a;null==d&&(d="");null==c&&(c="");d=String(d);c=String(c);this.caseSensitive||(d=d.toUpperCase(),c=c.toUpperCase());if(d===c){if(b===a)return 0;if(void 0===
b)return-1;if(void 0===a)return 1;if(null===b)return-1;if(null===a)return 1}return d<c?-1:1},h=function(b,a){b=Number(b);a=Number(a);return b===a?0:b<a?-1:1},f=function(b,a){b=Math.floor(Number(b));a=Math.floor(Number(a));return b===a?0:b<a?-1:1};this.items=[];this.indexesOfSourceData=[];this.trimByCollect=d;this.caseSensitive=c;this.skipSort=k;this.fieldLength=g;this.fieldNames=Array(g);this.fieldSortDirection=Array(g);this.fieldCompare=Array(g);for(d=0;d<g;d++){c=l[d];this.fieldNames[d]=c[n||"dataName"];
switch(c.sorttype){case "integer":case "int":this.fieldCompare[d]=f;break;case "number":case "currency":case "float":this.fieldCompare[d]=h;break;default:this.fieldCompare[d]=m.isFunction(c.compare)?c.compare:x}this.fieldSortDirection[d]="desc"===c.sortorder?-1:1}}var Q=m.jgrid;J.prototype.calc=function(d,c,k,l,n){if(void 0!==d)switch(this.result=this.result||0,d=parseFloat(d),this.aggregator){case "sum":this.result+=d;break;case "count":this.result++;break;case "avg":this.finilized?(this.count=this.count||
0,this.result=(this.result*this.count+d)/(this.count+1)):(this.result+=d,this.count=this.count||0);this.count++;break;case "min":this.result=Math.min(this.result,d);break;case "max":this.result=Math.max(this.result,d);break;default:m.isFunction(this.aggregator)&&(this.result=this.aggregator.call(this.context,{previousResult:this.result,value:d,fieldName:c,item:k,iItem:l,items:n}))}};J.prototype.getResult=function(d,c,k){if(void 0!==this.result||k)k&&void 0!==this.result&&(this.count=this.result=0),
void 0===this.result||this.finilized||"avg"!==this.aggregator||(this.result/=this.count,this.finilized=!0),d[c]=this.result};D.prototype.compareVectorsEx=function(d,c){var k=this.fieldLength,l,m;for(l=0;l<k;l++)if(m=this.fieldCompare[l](d[l],c[l]),0!==m)return{index:l,result:m};return{index:-1,result:0}};D.prototype.getIndexOfDifferences=function(d,c){return null===c||null===d?0:this.compareVectorsEx(d,c).index};D.prototype.compareVectors=function(d,c){var k=this.compareVectorsEx(d,c);return 0<(0<=
k.index?this.fieldSortDirection[k.index]:1)?k.result:-k.result};D.prototype.getItem=function(d){return this.items[d]};D.prototype.getIndexLength=function(){return this.items.length};D.prototype.getIndexesOfSourceData=function(d){return this.indexesOfSourceData[d]};D.prototype.createDataIndex=function(d){var c,k=d.length,l=this.fieldLength,n,g,x=this.fieldNames,h=this.indexesOfSourceData,f,b,a=this.items,q;for(c=0;c<k;c++){b=d[c];n=Array(l);for(f=0;f<l;f++)g=b[x[f]],void 0!==g&&("string"===typeof g&&
this.trimByCollect&&(g=m.trim(g)),n[f]=g);b=0;q=a.length-1;if(0>q)a.push(n),h.push([c]);else if(g=this.compareVectors(n,a[q]),0===g)h[q].push(c);else if(1===g||this.skipSort)a.push(n),h.push([c]);else if(g=this.compareVectors(a[0],n),1===g)a.unshift(n),h.unshift([c]);else if(0===g)h[0].push(c);else for(;;){if(2>q-b){a.splice(q,0,n);h.splice(q,0,[c]);break}f=Math.floor((b+q)/2);g=this.compareVectors(a[f],n);if(0===g){h[f].push(c);break}1===g?q=f:b=f}}};Q.extend({pivotSetup:function(d,c){var k=this[0],
l=m.isArray,n={},g={groupField:[],groupSummary:[],groupSummaryPos:[]},x={grouping:!0,groupingView:g},h=m.extend({totals:!1,useColSpanStyle:!1,trimByCollect:!0,skipSortByX:!1,skipSortByY:!1,caseSensitive:!1,footerTotals:!1,groupSummary:!0,groupSummaryPos:"header",frozenStaticCols:!1,defaultFormatting:!0,data:d},c||{}),f,b,a,q=d.length,E,e,v,y,B,U,R=h.xDimension,M=h.yDimension,F=h.aggregates,N,q=h.totalText||h.totals||h.rowTotals||h.totalHeader,r,G=l(R)?R.length:0;y=l(M)?M.length:0;var p=l(F)?F.length:
0,z=y-(1===p?1:0),H=[],K=[],O=[],l=[],V=Array(p),P=Array(y),S,Y,w,W,L,I,A,t,C,T,u;b=function(a,b,c){a=new D(h.trimByCollect,h.caseSensitive,b,a);m.isFunction(c)&&(a.compareVectorsEx=c);a.createDataIndex(d);return a};var aa=function(a,b,d,c,f){var e,g;switch(a){case 1:e=M[c].totalText||"{0} {1} {2}";g="y"+f+"t"+c;break;case 2:e=h.totalText||"{0}";g="t";break;default:e=1<p?b.label||"{0}":u.getItem(f)[c],g="y"+f}a=m.extend({},b,{name:g+(1<p?"a"+d:""),label:m.isFunction(e)?e.call(k,2===a?{aggregate:b,
iAggregate:d,pivotOptions:h}:{yIndex:u.getItem(f),aggregate:b,iAggregate:d,yLevel:c,pivotOptions:h}):Q.template.apply(k,2===a?[e,b.aggregator,b.member,d]:[e,b.aggregator,b.member,u.getItem(f)[c],c])});delete a.member;delete a.aggregator;return a};B=function(a,b,d){var c,e;for(c=0;c<p;c++)e=F[c],void 0===e.template&&void 0===e.formatter&&h.defaultFormatting&&(e.template="count"===e.aggregator?"integer":"number"),O.push(aa(a,e,c,b,d))};S=function(a,b,c){var d,e,f,g;for(d=z-1;d>=b;d--)if(K[d]){for(e=
0;e<=d;e++)C=H[e].groupHeaders,C[C.length-1].numberOfColumns+=p;E=M[d];f=E.totalHeader;g=E.headerOnTop;for(e=d+1;e<=z-1;e++)H[e].groupHeaders.push({titleText:g&&e===d+1||!g&&e===z-1?m.isFunction(f)?f.call(k,c,d):Q.template.call(k,f||"",c[d],d):"",startColumnName:"y"+(a-1)+"t"+d+(1===p?"":"a0"),numberOfColumns:p})}};var X=function(a){a=new J("count"===F[a].aggregator?"sum":F[a].aggregator,k,c);a.groupInfo={iRows:[],rows:[],ys:[],iYs:[]};return a},ba=function(){var a,b;for(a=z-1;0<=a;a--)if(K[a])for(null==
P[a]&&(P[a]=Array(p)),b=0;b<p;b++)P[a][b]=X(b)},Z=function(a,b,d,c){var e,f=u.getIndexOfDifferences(b,d),g,h;if(null!==d)for(f=Math.max(f,0),e=z-1;e>=f;e--)g="y"+a+"t"+e+(1<p?"a"+c:""),K[e]&&void 0===A[g]&&(h=P[e][c],h.getResult(A,g),A.pivotInfos[g]={colType:1,iA:c,a:F[c],level:e,iRows:h.groupInfo.iRows,rows:h.groupInfo.rows,ys:h.groupInfo.ys,iYs:h.groupInfo.iYs},b!==d&&(P[e][c]=X(c)))},ca=function(a,b,c,e,f,g,h){var k;if(a!==b)for(b=z-1;0<=b;b--)K[b]&&(k=P[b][e],k.calc(f[c.member],c.member,f,g,d),
k=k.groupInfo,0>m.inArray(h,k.iYs)&&(k.iYs.push(h),k.ys.push(a)),0>m.inArray(g,k.iRows)&&(k.iRows.push(g),k.rows.push(f)))};if(0===G||0===p)throw"xDimension or aggregates options are not set!";T=b(R,h.skipSortByX,h.compareVectorsByX);u=b(M,h.skipSortByY,h.compareVectorsByY);c.xIndex=T;c.yIndex=u;for(b=0;b<G;b++)a=R[b],e={name:"x"+b,label:null!=a.label?m.isFunction(a.label)?a.label.call(k,a,b,h):a.label:a.dataName,frozen:h.frozenStaticCols},b<G-1&&(g.groupField.push(e.name),g.groupSummary.push(h.groupSummary),
g.groupSummaryPos.push(h.groupSummaryPos)),e=m.extend(e,a),delete e.dataName,delete e.footerText,O.push(e);2>G&&(x.grouping=!1);x.sortname=O[G-1].name;g.hideFirstGroupCol=!0;for(b=0;b<y;b++)E=M[b],K.push(E.totals||E.rowTotals||E.totalText||E.totalHeader?!0:!1);t=u.getItem(0);B(0,y-1,0);g=u.getIndexLength();for(e=1;e<g;e++){w=u.getItem(e);b=u.getIndexOfDifferences(w,t);for(a=z-1;a>=b;a--)K[a]&&B(1,a,e-1);t=w;B(0,y-1,e)}for(b=z-1;0<=b;b--)K[b]&&B(1,b,g-1);q&&B(2);t=u.getItem(0);for(a=0;a<z;a++)H.push({useColSpanStyle:h.useColSpanStyle,
groupHeaders:[{titleText:t[a],startColumnName:1===p?"y0":"y0a0",numberOfColumns:p}]});for(e=1;e<g;e++){w=u.getItem(e);b=u.getIndexOfDifferences(w,t);S(e,b,t);for(a=z-1;a>=b;a--)H[a].groupHeaders.push({titleText:w[a],startColumnName:"y"+e+(1===p?"":"a0"),numberOfColumns:p});for(a=0;a<b;a++)C=H[a].groupHeaders,C[C.length-1].numberOfColumns+=p;t=w}S(g,0,t);if(q)for(b=0;b<z;b++)H[b].groupHeaders.push({titleText:b<z-1?"":h.totalHeader||"",startColumnName:"t"+(1===p?"":"a0"),numberOfColumns:p});S=T.getIndexLength();
for(y=0;y<S;y++){a=T.getItem(y);B={iX:y,x:a};A={pivotInfos:B};for(b=0;b<G;b++)A["x"+b]=a[b];Y=T.getIndexesOfSourceData(y);if(q)for(a=0;a<p;a++)V[a]=X(a);t=null;ba();for(e=0;e<g;e++){w=u.getItem(e);W=u.getIndexesOfSourceData(e);for(a=0;a<p;a++){null!==t&&Z(e-1,w,t,a);L=[];for(b=0;b<W.length;b++)v=W[b],0<=m.inArray(v,Y)&&L.push(v);if(0<L.length){U=Array(L.length);I=F[a];N=new J(I.aggregator,k,c);for(v=0;v<L.length;v++)b=L[v],f=d[b],U[v]=f,N.calc(f[I.member],I.member,f,b,d),q&&(r=V[a],r.calc(f[I.member],
I.member,f,b,d),r=r.groupInfo,0>m.inArray(b,r.iYs)&&(r.iYs.push(e),r.ys.push(w)),0>m.inArray(b,r.iRows)&&(r.iRows.push(b),r.rows.push(f))),ca(w,t,I,a,f,b,e);f="y"+e+(1===p?"":"a"+a);N.getResult(A,f);B[f]={colType:0,iY:e,y:w,iA:a,a:I,iRows:L,rows:U}}}t=w}if(null!==t)for(a=0;a<p;a++)Z(g-1,t,t,a);if(q)for(a=0;a<p;a++)f="t"+(1===p?"":"a"+a),r=V[a],r.getResult(A,f),r=r.groupInfo,B[f]={colType:2,iA:a,a:F[a],iRows:r.iRows,rows:r.rows,iYs:r.iYs,ys:r.ys};l.push(A)}if(h.footerTotals||h.colTotals){q=l.length;
for(b=0;b<G;b++)n["x"+b]=R[b].footerText||"";for(b=G;b<O.length;b++){f=O[b].name;N=new J(h.footerAggregator||"sum",k,c);for(v=0;v<q;v++)A=l[v],N.calc(A[f],f,A,v,l);N.getResult(n,f)}}c.colHeaders=H;return{colModel:O,options:c,rows:l,groupOptions:x,groupHeaders:H,summary:n}},jqPivot:function(d,c,k,l){return this.each(function(){function n(){var f=h.pivotSetup.call(x,d,c),b=f.groupHeaders,a=f.summary,l=0,n;for(n in a)a.hasOwnProperty(n)&&l++;a=0<l?!0:!1;l=f.groupOptions.groupingView;n=Q.from.call(g,
f.rows);var e;if(c.skipSortByX)for(e=0;e<l.groupField.length;e++)n.orderBy(l.groupField[e],null!=k&&k.groupingView&&null!=k.groupingView.groupOrder&&"desc"===k.groupingView.groupOrder[e]?"d":"a","text","");c.data=d;h.call(x,m.extend(!0,{datastr:m.extend(n.select(),a?{userdata:f.summary}:{}),datatype:"jsonstring",footerrow:a,userDataOnFooter:a,colModel:f.colModel,pivotOptions:f.options,additionalProperties:["pivotInfos"],viewrecords:!0,sortname:c.xDimension[0].dataName},f.groupOptions,k||{}));if(b.length)for(e=
0;e<b.length;e++)b[e]&&b[e].groupHeaders.length&&h.setGroupHeaders.call(x,b[e]);c.frozenStaticCols&&h.setFrozenColumns.call(x)}var g=this,x=m(g),h=m.fn.jqGrid;"string"===typeof d?m.ajax(m.extend({url:d,dataType:"json",success:function(c){d=Q.getAccessor(c,l&&l.reader?l.reader:"rows");n()}},l||{})):n()})}})});
//# sourceMappingURL=grid.pivot.map
